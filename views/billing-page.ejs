<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ali Plastic Store | Advanced POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --danger: #ef4444; 
            --success: #10b981; 
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            color: var(--text-main);
        }

        /* Responsive Grid Logic */
        .main-grid { 
            display: grid; 
            grid-template-columns: 1fr 420px; 
            gap: 20px; 
            padding: 20px; 
            flex: 1; 
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 1024px) {
            .main-grid { grid-template-columns: 1fr; }
            .cart-panel { position: sticky; bottom: 20px; max-height: 60vh; }
        }

        /* Search Bar Enhancement */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        .search-box { 
            width: 100%; padding: 14px 14px 14px 45px; border-radius: 12px; 
            border: 1px solid #e2e8f0; font-size: 1rem; box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); outline: none; transition: 0.3s;
        }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }

        /* Product Cards */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; 
            align-content: start;
        }

        .p-card { 
            background: var(--card); border-radius: 16px; border: 1px solid #e2e8f0; 
            padding: 15px; transition: 0.3s; position: relative; overflow: hidden;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .p-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .p-name { font-weight: 700; font-size: 1rem; margin-bottom: 5px; height: 40px; overflow: hidden; }
        .p-stock { 
            font-size: 0.7rem; font-weight: 800; background: #f1f5f9; 
            padding: 4px 8px; border-radius: 6px; color: var(--primary); margin-bottom: 12px;
            display: inline-block;
        }

        /* Modern Add Buttons */
        .format-btns { display: flex; flex-direction: column; gap: 8px; }
        .btn-add { 
            border: 1px solid #f1f5f9; background: #f8fafc; padding: 10px; 
            border-radius: 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer; 
            transition: 0.2s; color: var(--text-main); display: flex; justify-content: space-between;
        }
        .btn-add:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* Sleek Cart Panel */
        .cart-panel { 
            background: var(--card); border-radius: 20px; display: flex; flex-direction: column; 
            border: 1px solid #e2e8f0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
            height: calc(100vh - 120px); position: sticky; top: 100px;
        }
        .cart-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .cart-header h2 { margin: 0; font-size: 1.2rem; font-weight: 800; }
        
        .cart-list { flex: 1; overflow-y: auto; padding: 15px; scrollbar-width: thin; }
        
        /* Modern Cart Items */
        .cart-item { 
            background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 12px; 
            border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.01);
        }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .negotiate-input { 
            width: 80px; padding: 6px; border: 1.5px solid #e2e8f0; border-radius: 8px; 
            text-align: right; font-weight: 800; color: var(--primary);
        }

        /* Footer / Totals */
        .cart-footer { padding: 20px; background: #fff; border-top: 1px solid #f1f5f9; border-radius: 0 0 20px 20px; }
        .summary-line { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .summary-total { font-size: 1.5rem; font-weight: 900; color: var(--text-main); margin-top: 10px; border-top: 2px solid #f1f5f9; padding-top: 10px; }
        
        .checkout-btn { 
            width: 100%; padding: 16px; background: var(--success); color: white; 
            border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; 
            cursor: pointer; transition: 0.3s; margin-top: 15px;
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.3);
        }
        .checkout-btn:hover { background: #059669; transform: translateY(-2px); }
        .checkout-btn:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .price-warning { border-color: var(--danger) !important; color: var(--danger) !important; background: #fff1f2; }
        .hidden { display: none !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

<%- include('partials/navbar') %>

<div class="main-grid">
    <div class="product-section">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="pSearch" onkeyup="search()" class="search-box" placeholder="Search product name, size or type...">
        </div>

        <div class="product-grid">
            <% products.forEach(p => { %>
                <div class="p-card" id="card-<%= p._id %>">
                    <div>
                        <span class="p-stock" data-base="<%= p.totalItems %>">
                            Stock: <span class="stock-num"><%= p.totalItems %></span>
                        </span>
                        <div class="p-name"><%= p.prodName %> <span style="color:var(--text-sub)"><%= p.unitVal %> <%= p.unitType %></span></div>
                    </div>
                    
                    <div class="format-btns">
                        <button class="btn-add <%= ['Packet','Single'].includes(p.buyFormat) ? 'hidden' : '' %>" 
                                onclick="handleAddToCart('<%= p._id %>', 'bulk')">
                            <span>Bulk (<%= p.buyFormat %>)</span>
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <button class="btn-add <%= ['Bag','Single'].includes(p.buyFormat) ? 'hidden' : '' %>" 
                                onclick="handleAddToCart('<%= p._id %>', 'sub')"> 
                            <span>Packet</span>
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <button class="btn-add" onclick="handleAddToCart('<%= p._id %>', 'unit')">
                            <span>Piece / Kg</span>
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>

    <div class="cart-panel">
        <div class="cart-header">
            <h2><i class="fas fa-shopping-cart" style="color:var(--primary)"></i> Checkout</h2>
            <span id="itemCount" class="p-stock">0 items</span>
        </div>

        <div class="cart-list" id="cartBody">
            <div style="text-align:center; color:var(--text-sub); margin-top:40px;">
                <i class="fas fa-cart-arrow-down" style="font-size:3rem; opacity:0.2;"></i>
                <p>Cart is empty</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="summary-line" style="color: var(--success); font-weight: 700; display: none;">
                <span>Total Profit</span>
                <span id="totalProfitDisplay">Rs 0.00</span>
            </div>
            <div class="summary-line summary-total">
                <span>Grand Total</span>
                <span id="grandTotal">Rs 0.00</span>
            </div>
            <button id="finishBtn" class="checkout-btn" onclick="submitSale()" disabled>
                FINALIZE SALE
            </button>
        </div>
    </div>
</div>

<script>
    /* Keep your existing script logic here exactly as it was. 
       The class names and IDs have been preserved to ensure functionality remains 100% same.
    */
    const dbItems = {
        <% products.forEach(p => { %>
            "<%= p._id %>": {
                name: "<%= p.prodName.replace(/'/g, "\\'") %> (<%= p.unitVal %> <%= p.unitType %>)",
                buyPrice: <%= p.unitCost || 0 %>,
                sellPrice: <%= p.sellPrice || 0 %>,
                q1: <%= p.subQty1 || 1 %>,
                q2: <%= p.subQty2 || 1 %>,
                format: "<%= p.buyFormat %>",
                totalItems: <%= p.totalItems %>
            },
        <% }) %>
    };

    let basket = [];

    function search() {
        let q = document.getElementById('pSearch').value.toLowerCase();
        document.querySelectorAll('.p-card').forEach(c => {
            c.style.display = c.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
        });
    }

    function getMult(id, mode) {
        const p = dbItems[id];
        if (mode === 'bulk') return (p.format === 'Carton') ? (p.q1 * p.q2) : p.q1;
        if (mode === 'sub') return (p.format === 'Carton') ? p.q2 : p.q1;
        return 1;
    }

    function handleAddToCart(id, mode) {
        const p = dbItems[id];
        const mult = getMult(id, mode);
        let used = basket.reduce((sum, item) => sum + (getMult(item.id, item.mode) * item.qty), 0);
        if ((used + mult) > p.totalItems) return alert("Insufficient Stock!");

        let existing = basket.find(i => i.id === id && i.mode === mode);
        if (existing) {
            existing.qty++;
        } else {
            let priceForThisMode = (p.sellPrice * mult).toFixed(2);
            basket.push({
                id: id,
                name: p.name,
                mode: mode,
                qty: 1,
                costPrice: (p.buyPrice * mult).toFixed(2),
                negotiatedPrice: priceForThisMode,
                formatName: mode === 'bulk' ? p.format : (mode === 'sub' ? 'Packet' : 'Piece')
            });
        }
        render();
    }

    function render() {
        const body = document.getElementById('cartBody');
        if(basket.length === 0) {
            body.innerHTML = `<div style="text-align:center; color:var(--text-sub); margin-top:40px;"><i class="fas fa-cart-arrow-down" style="font-size:3rem; opacity:0.2;"></i><p>Cart is empty</p></div>`;
            document.getElementById('grandTotal').innerText = `Rs 0.00`;
            document.getElementById('totalProfitDisplay').innerText = `Rs 0.00`;
            document.getElementById('finishBtn').disabled = true;
            return;
        }

        body.innerHTML = '';
        let total = 0;
        let totalProfit = 0;
        let isInvalid = false;

        basket.forEach((item, idx) => {
            const lineTotal = item.negotiatedPrice * item.qty;
            const lineCost = item.costPrice * item.qty;
            const lineProfit = lineTotal - lineCost;
            total += lineTotal;
            totalProfit += lineProfit;

            const tooLow = parseFloat(item.negotiatedPrice) < parseFloat(item.costPrice);
            if (tooLow) isInvalid = true;

            body.innerHTML += `
                <div class="cart-item" style="border-left: 4px solid ${lineProfit >= 0 ? 'var(--success)' : 'var(--danger)'}">
                    <div class="item-row">
                        <div>
                            <div style="font-weight:800; font-size:0.95rem;">${item.name}</div>
                            <div style="font-size:0.75rem; color:var(--text-sub); font-weight:600;">
                                Format/Mode: ${item.formatName} 
                            </div>
                        </div>
                        <button onclick="removeItem(${idx})" style="background:none; border:none; color:#cbd5e1; cursor:pointer;"><i class="fas fa-times-circle"></i></button>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; background:#f1f5f9; border-radius:8px; padding:2px;">
    <button class="btn-add" style="border:none; padding:5px 10px;" onclick="changeQty(${idx}, -1)">-</button>
    
    <input type="number" 
           value="${item.qty}" 
           min="1"
           style="width: 50px; border: none; background: transparent; text-align: center; font-weight: 800; font-family: inherit; font-size: 0.9rem; outline: none;"
           onchange="manualQty(${idx}, this.value)">
    
    <button class="btn-add" style="border:none; padding:5px 10px;" onclick="changeQty(${idx}, 1)">+</button>
</div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size:0.8rem; font-weight:800;">Rs</span>
                            <input type="number" 
                                class="negotiate-input ${tooLow ? 'price-warning' : ''}" 
                                value="${item.negotiatedPrice}" 
                                oninput="updatePrice(${idx}, this.value)">
                        </div>
                    </div>
                </div>`;
        });

        document.getElementById('grandTotal').innerText = `Rs ${total.toFixed(2)}`;
        const profitDisplay = document.getElementById('totalProfitDisplay');
    if (profitDisplay) {
        profitDisplay.innerText = `Rs ${totalProfit.toFixed(2)}`;
    }

    document.getElementById('itemCount').innerText = `${basket.length} items`;
    
    // This line will finally run now!
    document.getElementById('finishBtn').disabled = isInvalid || basket.length === 0;
        document.getElementById('totalProfitDisplay').innerText = `Rs ${totalProfit.toFixed(2)}`;
        document.getElementById('itemCount').innerText = `${basket.length} items`;
        document.getElementById('finishBtn').disabled = isInvalid || basket.length === 0;
    }

    // Include other helper functions (updatePrice, changeQty, removeItem, submitSale) below...
    function updatePrice(idx, val) { basket[idx].negotiatedPrice = val; render(); }
    function changeQty(idx, delta) {
        const item = basket[idx];
        const mult = getMult(item.id, item.mode);
        const p = dbItems[item.id];
        let usedOther = basket.reduce((sum, i, iIdx) => iIdx !== idx && i.id === item.id ? sum + (getMult(i.id, i.mode) * i.qty) : sum, 0);
        if ((usedOther + (item.qty + delta) * mult) > p.totalItems) return alert("Stock Limit!");
        item.qty += delta;
        if (item.qty <= 0) basket.splice(idx, 1);
        render();
    }
    function manualQty(idx, val) {
    const newVal = parseInt(val);
    const item = basket[idx];
    const mult = getMult(item.id, item.mode);
    const p = dbItems[item.id];

    // 1. Prevent non-numbers or values less than 1
    if (isNaN(newVal) || newVal < 1) {
        item.qty = 1;
        render();
        return;
    }

    // 2. Stock Check
    let usedOther = basket.reduce((sum, i, iIdx) => 
        iIdx !== idx && i.id === item.id ? sum + (getMult(i.id, i.mode) * i.qty) : sum, 0);
    
    if ((usedOther + (newVal * mult)) > p.totalItems) {
        alert("Stock Limit Reached!");
        render(); // Resets input to previous valid qty
        return;
    }

    // 3. Update and Refresh
    item.qty = newVal;
    render();
}
    function removeItem(idx) { basket.splice(idx, 1); render(); }
    async function submitSale() {
        const items = basket.map(i => ({ id: i.id, qty: i.qty, mode: i.mode, price: i.negotiatedPrice }));
        const res = await fetch('/inventory/checkout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items })
        });
        if(res.ok) { alert("Sale Completed"); window.location.reload(); }
        else alert("Error during checkout");
    }
</script>
</body>
</html>
