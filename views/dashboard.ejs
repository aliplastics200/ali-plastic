<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ali Plastic Store | Inventory Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
    :root {
        --primary: #2563eb; --secondary: #64748b; --success: #22c55e;
        --danger: #ef4444; --bg: #f8fafc; --card: #ffffff; --text: #1e293b;
    }

    body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 50px; }
    
    .container { max-width: 1200px; margin: 1rem auto; padding: 0 1rem; }

    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--card); padding: 1.25rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 1rem; border: 1px solid #e2e8f0; }
    .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .blue { background: #dbeafe; color: var(--primary); }
    .green { background: #dcfce7; color: var(--success); }

    /* Search Bar */
    .search-box { position: relative; margin-bottom: 1.5rem; }
    .search-box input { width: 100%; padding: 12px 45px; border-radius: 10px; border: 1px solid #e2e8f0; font-size: 1rem; box-sizing: border-box; outline: none; transition: 0.3s; }
    .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary); }

    /* Table & Badges */
    .table-container { background: var(--card); border-radius: 12px; border: 1px solid #e2e8f0; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 1rem; text-align: left; font-size: 0.75rem; color: var(--secondary); text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
    td { padding: 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }

    .badge { padding: 0.35rem 0.6rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
    .profit-badge { background: #dcfce7; color: #166534; }
    .stock-badge { background: #f1f5f9; color: #475569; }
    .low-stock { background: #fee2e2; color: #991b1b; }

    .action-btns { display: flex; gap: 20px; font-size: 1.1rem; }
    .btn-edit { color: var(--primary); cursor: pointer; }
    .btn-delete { color: var(--danger); cursor: pointer; }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--secondary);
    }
    .empty-state i { font-size: 3.5rem; color: #e2e8f0; margin-bottom: 15px; display: block; }
    .empty-state h2 { color: var(--text); margin: 0; font-size: 1.25rem; }

    /* RESPONSIVE BREAKPOINT */
    @media (max-width: 768px) {
        thead { display: none; }
        tr { display: block; border-bottom: 8px solid #f1f5f9; padding: 15px; position: relative; }
        td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; }
        td:first-child { display: block; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        td:last-child { margin-top: 10px; padding-top: 10px; border-top: 1px solid #f1f5f9; }
        td:nth-of-type(2):before { content: "Format"; font-weight: 600; color: var(--secondary); }
        td:nth-of-type(3):before { content: "Stock"; font-weight: 600; color: var(--secondary); }
        td:nth-of-type(4):before { content: "Cost"; font-weight: 600; color: var(--secondary); }
        td:nth-of-type(5):before { content: "Sell"; font-weight: 600; color: var(--secondary); }
        td:nth-of-type(6):before { content: "Profit"; font-weight: 600; color: var(--secondary); }
    }
</style>
</head>
<body>

<%- include('partials/navbar') %>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue"><i class="fas fa-tag"></i></div>
            <div>
                <p style="margin:0; color:var(--secondary); font-size: 0.75rem;">Products</p>
                <h3 style="margin:0;"><%= products.length %></h3>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green"><i class="fas fa-wallet"></i></div>
            <div>
                <p style="margin:0; color:var(--secondary); font-size: 0.75rem;">Inv. Value</p>
                <h3 style="margin:0;">Rs <%= products.reduce((acc, p) => acc + (parseFloat(p.unitCost) * p.totalItems), 0).toLocaleString() %></h3>
            </div>
        </div>
    </div>

    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search product name..." onkeyup="filterTable()">
    </div>

    <div class="table-container">
        <% if (products.length > 0) { %>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Format</th>
                        <th>Stock</th>
                        <th>Cost</th>
                        <th>Sell</th>
                        <th>Profit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% products.forEach(p => { %>
                    <tr>
                        <td>
                            <div style="font-weight: 700;"><%= p.prodName %></div>
                            <div style="font-size: 0.75rem; color: var(--secondary);"><%= p.unitVal %> <%= p.unitType %></div>
                        </td>
                        <td><%= p.buyFormat %></td>
                        <td>
                            <span class="badge stock-badge <%= p.totalItems < 10 ? 'low-stock' : '' %>">
                                <%= p.totalItems %> <%= p.buyFormat === 'Bag' ? 'Kg' : 'Pcs' %>
                            </span>
                        </td>
                        <td>Rs <%= p.unitCost %></td>
                        <td>Rs <%= p.sellPrice %></td>
                        <td><span class="badge profit-badge">Rs <%= p.profit %></span></td>
                        <td>
                            <div class="action-btns">
                                <a href="/inventory/edit/<%= p._id %>" class="btn-edit"><i class="fas fa-edit"></i></a>
                                <a onclick="deleteProduct('<%= p._id %>', '<%= p.prodName %>')" class="btn-delete"><i class="fas fa-trash"></i></a>
                            </div>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>

            <div id="noResults" class="empty-state" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h2>No matches found</h2>
                <p>Try adjusting your search terms.</p>
            </div>

        <% } else { %>
            <div class="empty-state">
                <i class="fas fa-layer-group"></i>
                <h2>Inventory is empty</h2>
                <p>Start by adding your first product to the system.</p>
                <a href="/inventory/add-page" style="display:inline-block; margin-top:15px; background:var(--primary); color:white; padding:10px 20px; border-radius:8px; text-decoration:none; font-weight:600;">+ Add Product</a>
            </div>
        <% } %>
    </div>
</div>

<script>
    // Improved Search Filter Logic
    function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("productTable");
        if (!table) return;

        const tr = table.getElementsByTagName("tr");
        const noResults = document.getElementById("noResults");
        const thead = table.getElementsByTagName("thead")[0];
        let visibleCount = 0;

        for (let i = 1; i < tr.length; i++) {
            const tdName = tr[i].getElementsByTagName("td")[0];
            if (tdName) {
                const txtValue = tdName.textContent || tdName.innerText;
                const matches = txtValue.toUpperCase().indexOf(filter) > -1;
                tr[i].style.display = matches ? "" : "none";
                if(matches) visibleCount++;
            }
        }

        // Toggle empty state and headers
        if (noResults) {
            noResults.style.display = visibleCount === 0 ? "block" : "none";
            if (thead) thead.style.display = visibleCount === 0 ? "none" : "";
        }
    }

    // Delete Logic
    async function deleteProduct(id, name) {
        if (confirm(`⚠️ Delete "${name}"?\nThis cannot be undone.`)) {
            try {
                const res = await fetch(`/inventory/delete/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to delete.");
                }
            } catch (err) {
                console.error(err);
                alert("Error connecting to server.");
            }
        }
    }
</script>

</body>
</html>
