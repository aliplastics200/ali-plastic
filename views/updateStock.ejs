<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ali Plastic Store | Smart Restock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8; --secondary: #5f6368; --success: #2e7d32;
            --danger: #d93025; --warning: #f9ab00; --bg: #f8f9fa;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); color: #202124; }
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .section { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 1px 2px rgba(60,64,67,0.3); border: 1px solid #dadce0; }
        h2 { margin-top: 0; color: var(--primary); font-size: 1.25rem; font-weight: 500; }
        label { font-weight: 600; display: block; margin-top: 15px; font-size: 0.85rem; color: #5f6368; }
        input, select { width: 100%; padding: 12px; margin-top: 6px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        input[readonly] { background-color: #f1f3f4; cursor: not-allowed; color: #5f6368; border-style: dashed; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .price-container { background: #fdfdfd; padding: 20px; border-radius: 10px; border: 1px dashed #dadce0; margin-top: 25px; }
        .price-group-label { font-size: 0.9rem; font-weight: bold; color: var(--primary); text-transform: uppercase; margin-bottom: 15px; display: block; }
        .summary-box { background: #e8f0fe; padding: 20px; border-radius: 8px; margin-top: 25px; border-left: 6px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .summary-val { font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .error-text { color: var(--danger); font-size: 0.75rem; margin-top: 4px; display: block; min-height: 15px; }
        button.btn-save { width: 100%; padding: 16px; background: var(--success); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 30px; font-size: 1rem; transition: 0.2s; }
        button:disabled { background-color: #dadce0; cursor: not-allowed; color: #9aa0a6; }
        .hidden { display: none; }
    </style>
</head>
<body>

<%- include('partials/navbar') %>


<div class="container">
    <div class="section">
        <h2>Restock Inventory</h2>
        
        <label>Select Product <span style="color:red">*</span></label>
        <select id="productId" onchange="loadProductData()">
            <option value="">-- Choose Product --</option>
            <% products.forEach(p => { %>
                <option value="<%= p._id %>" 
                        data-cost="<%= p.unitCost %>" 
                        data-sell="<%= p.sellPrice %>" 
                        data-val="<%= p.unitVal %>" 
                        data-type="<%= p.unitType %>"
                        data-format="<%= p.buyFormat %>"
                        data-items="<%= p.totalItems %>"
                        data-q1="<%= p.subQty1 || 1 %>"
                        data-q2="<%= p.subQty2 || 1 %>">
                    <%= p.prodName %> (<%= p.unitVal %> <%= p.unitType %>)
                </option>
            <% }) %>
        </select>
        
        <div id="productDetails" class="hidden">
            <div class="grid-3">
                <div><label>Format</label><input type="text" id="buyFormatDisplay" readonly></div>
                <div><label>Current Stock</label><input type="text" id="oldStockVal" readonly></div>
                <div><label>Unit Size</label><input type="text" id="unitSizeDisplay" readonly></div>
            </div>

            <div id="quantityGrid" class="grid-3">
                <div id="mainQtyGroup">
                    <label id="mainQtyLabel">Number of Cartons</label>
                    <input type="number" id="mainQty" value="1" min="1" oninput="calculate()">
                </div>
                <div id="subQtyGroup1">
                    <label id="subQtyLabel1">Packets per Carton</label>
                    <input type="number" id="subQty1" readonly>
                </div>
                <div id="subQtyGroup2">
                    <label id="subQtyLabel2">Pieces per Packet</label>
                    <input type="number" id="subQty2" readonly>
                </div>
            </div>

            <div class="price-container">
                <span class="price-group-label"><i class="fas fa-arrow-down"></i> Buying Prices</span>
                <div class="grid-3">
                    <div id="bcG"><label id="bcL">Price/Ctn</label><input type="number" id="buyPriceCarton" step="any" oninput="distributePrice('buy', 'carton')"></div>
                    <div id="bpG"><label id="bpL">Price/Pkt</label><input type="number" id="buyPricePacket" step="any" oninput="distributePrice('buy', 'packet')"></div>
                    <div><label id="buL">Cost/Unit</label><input type="number" id="buyPricePiece" step="any" oninput="distributePrice('buy', 'piece')"></div>
                </div>

                <span class="price-group-label" style="margin-top:25px;"><i class="fas fa-arrow-up"></i> Selling Prices</span>
                <div class="grid-3">
                    <div id="scG"><label id="scL">Sell/Ctn</label><input type="number" id="sellPriceCarton" step="any" oninput="distributePrice('sell', 'carton')"></div>
                    <div id="spG"><label id="spL">Sell/Pkt</label><input type="number" id="sellPricePacket" step="any" oninput="distributePrice('sell', 'packet')"></div>
                    <div>
                        <label id="suL">Sell/Unit</label>
                        <input type="number" id="sellPricePiece" step="any" oninput="distributePrice('sell', 'piece')">
                        <span id="priceError" class="error-text"></span>
                    </div>
                </div>
            </div>

            <div class="summary-box">
                <div><i class="fas fa-plus"></i> Adding: <span class="summary-val" id="totalStockDisplay">0</span></div>
                <div style="text-align: right;">New Profit/Unit: <span class="summary-val" id="profitDisplay">Rs 0.00</span></div>
            </div>

            <button class="btn-save" onclick="updateStock()" id="saveBtn" disabled><i class="fas fa-check-circle"></i> Save Stock Update</button>
        </div>
    </div>
</div>

<script>
    function loadProductData() {
        const select = document.getElementById('productId');
        const opt = select.options[select.selectedIndex];
        if (!opt.value) {
            document.getElementById('productDetails').classList.add('hidden');
            return;
        }

        document.getElementById('productDetails').classList.remove('hidden');
        const format = opt.dataset.format;
        
        // 1. Set Read-only Info
        document.getElementById('buyFormatDisplay').value = format;
        document.getElementById('oldStockVal').value = opt.dataset.items + (format === 'Bag' ? ' Kg' : ' Pcs');
        document.getElementById('unitSizeDisplay').value = opt.dataset.val + " " + opt.dataset.type;
        document.getElementById('subQty1').value = opt.dataset.q1;
        document.getElementById('subQty2').value = opt.dataset.q2;

        // 2. Setup Labels and Visibility
        const g1 = document.getElementById('subQtyGroup1'), g2 = document.getElementById('subQtyGroup2');
        const bc = document.getElementById('bcG'), bp = document.getElementById('bpG'), sc = document.getElementById('scG'), sp = document.getElementById('spG');
        const buL = document.getElementById('buL'), suL = document.getElementById('suL');
        const bpL = document.getElementById('bpL'), spL = document.getElementById('spL');

        [g1, g2, bc, bp, sc, sp].forEach(el => el.classList.remove('hidden'));
        buL.innerText = "Cost per Piece"; suL.innerText = "Sell per Piece";
        bpL.innerText = "Price per Packet"; spL.innerText = "Sell per Packet";

        if (format === 'Carton') {
            document.getElementById('mainQtyLabel').innerText = "Number of Cartons";
            document.getElementById('subQtyLabel1').innerText = "Packets per Carton (Locked)";
            document.getElementById('subQtyLabel2').innerText = "Pieces per Packet (Locked)";
        } else if (format === 'Packet') {
            document.getElementById('mainQtyLabel').innerText = "Number of Packets";
            document.getElementById('subQtyLabel1').innerText = "Pieces per Packet (Locked)";
            [g2, bc, sc].forEach(el => el.classList.add('hidden'));
        } else if (format === 'Bag') {
            document.getElementById('mainQtyLabel').innerText = "Number of Bags";
            document.getElementById('subQtyLabel1').innerText = "Weight per Bag (Kg) (Locked)";
            bpL.innerText = "Price per Bag"; spL.innerText = "Sell per Bag";
            buL.innerText = "Cost per Kg"; suL.innerText = "Sell per Kg";
            [g2, bc, sc].forEach(el => el.classList.add('hidden'));
        } else if (format === 'Single') {
            document.getElementById('mainQtyLabel').innerText = "Total Pieces";
            [g1, g2, bc, bp, sc, sp].forEach(el => el.classList.add('hidden'));
        }

        // 3. Sync Prices
        document.getElementById('buyPricePiece').value = opt.dataset.cost;
        document.getElementById('sellPricePiece').value = opt.dataset.sell;
        distributePrice('buy', 'piece');
        distributePrice('sell', 'piece');
        calculate();
    }

    function distributePrice(mode, level) {
        const q1 = parseFloat(document.getElementById('subQty1').value) || 1;
        const q2 = parseFloat(document.getElementById('subQty2').value) || 1;
        const format = document.getElementById('buyFormatDisplay').value;
        const cIn = document.getElementById(mode + 'PriceCarton');
        const pIn = document.getElementById(mode + 'PricePacket');
        const uIn = document.getElementById(mode + 'PricePiece');

        if (format === 'Carton') {
            if (level === 'carton') { pIn.value = (cIn.value / q1).toFixed(2); uIn.value = (pIn.value / q2).toFixed(2); }
            else if (level === 'packet') { cIn.value = (pIn.value * q1).toFixed(2); uIn.value = (pIn.value / q2).toFixed(2); }
            else if (level === 'piece') { pIn.value = (uIn.value * q2).toFixed(2); cIn.value = (pIn.value * q1).toFixed(2); }
        } else if (format === 'Packet' || format === 'Bag') {
            // Logic for Bag: Packet field acts as "Bag Price", Piece field acts as "Kg Price"
            if (level === 'packet') uIn.value = (pIn.value / q1).toFixed(2);
            else if (level === 'piece') pIn.value = (uIn.value * q1).toFixed(2);
        }
        validate();
    }

    function calculate() {
        const main = parseFloat(document.getElementById('mainQty').value) || 0;
        const q1 = parseFloat(document.getElementById('subQty1').value) || 1;
        const q2 = parseFloat(document.getElementById('subQty2').value) || 1;
        const format = document.getElementById('buyFormatDisplay').value;
        
        let total = 0;
        if (format === 'Carton') total = main * q1 * q2;
        else if (format === 'Packet' || format === 'Bag') total = main * q1;
        else total = main;

        document.getElementById('totalStockDisplay').innerText = total + (format === 'Bag' ? " Kg" : " Pcs");
        validate();
        return total;
    }

    function validate() {
        const buy = parseFloat(document.getElementById('buyPricePiece').value) || 0;
        const sell = parseFloat(document.getElementById('sellPricePiece').value) || 0;
        const profit = sell - buy;
        const mainQty = parseFloat(document.getElementById('mainQty').value) || 0;
        
        const disp = document.getElementById('profitDisplay');
        disp.innerText = "Rs " + profit.toFixed(2);
        disp.style.color = profit > 0 ? "var(--success)" : "var(--danger)";

        const err = document.getElementById('priceError');
        const btn = document.getElementById('saveBtn');

        let hasError = false;
        if (profit <= 0) {
            err.innerText = profit < 0 ? "Loss Detected! Selling price must be higher than cost." : "Profit must be greater than zero.";
            hasError = true;
        } else { err.innerText = ""; }

        if (mainQty <= 0) hasError = true;
        btn.disabled = hasError;
    }

    async function updateStock() {
        const payload = {
            productId: document.getElementById('productId').value,
            addedItems: calculate(),
            unitCost: document.getElementById('buyPricePiece').value,
            sellPrice: document.getElementById('sellPricePiece').value,
            profit: (document.getElementById('sellPricePiece').value - document.getElementById('buyPricePiece').value).toFixed(2),
            // Including ratios and format for backend logs if needed
            subQty1: document.getElementById('subQty1').value,
            subQty2: document.getElementById('subQty2').value,
            format: document.getElementById('buyFormatDisplay').value
        };

        try {
            const res = await fetch('/inventory/restock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (res.ok) {
                alert("✅ Stock Updated!");
                window.location.reload();
            }
        } catch (err) { alert("❌ Server Error"); }
    }
</script>
</body>
</html>